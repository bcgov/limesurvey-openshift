name: Postgres image - Build and Push
run-name: Postgres Docker Build - ${{ github.event.head_commit.message || github.run_number }}
on:
  push:
    branches:
      - main
    paths:
      - "docker/postgres/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Tag the built image as:"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - test
          - prod
jobs:
  postgres-build-push-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    env:
      ENV_TAG: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Set up OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1.13.1
        with:
          oc: "4.16"
          skip_cache: true
      - name: Build Postgres Docker image
        run: |
          docker buildx build --file docker/postgres/Dockerfile --tag limesurvey-openshift/postgres:$ENV_TAG --load docker/postgres
      - name: Login to OpenShift Container Registry
        env:
          OPENSHIFT_SA_USER: ${{ secrets.OPENSHIFT_SA_USER }}
          OPENSHIFT_SA_TOKEN: ${{ secrets.OPENSHIFT_SA_TOKEN }}
          OPENSHIFT_IMAGE_REGISTRY: ${{ secrets.OPENSHIFT_IMAGE_REGISTRY }}
        run: |
          echo $OPENSHIFT_SA_TOKEN | docker login $OPENSHIFT_IMAGE_REGISTRY -u $OPENSHIFT_SA_USER --password-stdin
      - name: Push Postgres image to OpenShift Registry
        env:
          OPENSHIFT_IMAGE_REGISTRY: ${{ secrets.OPENSHIFT_IMAGE_REGISTRY }}
          OPENSHIFT_REPOSITORY: ${{ secrets.OPENSHIFT_REPOSITORY }}
        run: |
          docker tag limesurvey-openshift/postgres:$ENV_TAG $OPENSHIFT_IMAGE_REGISTRY/$OPENSHIFT_REPOSITORY/limesurvey-postgresql:$ENV_TAG
          docker push $OPENSHIFT_IMAGE_REGISTRY/$OPENSHIFT_REPOSITORY/limesurvey-postgresql:$ENV_TAG
          # Also push as "latest" if environment is dev
          if [ "$ENV_TAG" = "dev" ]; then
              docker tag limesurvey-openshift/postgres:dev $OPENSHIFT_IMAGE_REGISTRY/$OPENSHIFT_REPOSITORY/limesurvey-postgresql:latest
              docker push $OPENSHIFT_IMAGE_REGISTRY/$OPENSHIFT_REPOSITORY/limesurvey-postgresql:latest
          fi
